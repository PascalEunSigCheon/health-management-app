<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Manager - Simple Demo</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #6b7280;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --focus: #60a5fa;
      --card: #0b1220;
      --border: #1f2937;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1000px 500px at 10% 10%, #0b1220 10%, transparent 60%),
                  radial-gradient(800px 400px at 90% 0%, #0b1220 10%, transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .container {
      width: 100%;
      max-width: 960px;
    }

    .card {
      background: linear-gradient(180deg, var(--panel), rgba(17,24,39,0.6));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      margin: 0 0 12px 0;
      font-size: 22px;
      font-weight: 700;
    }

    .muted { color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    label { font-size: 13px; color: var(--muted); }
    input[type="text"], select, textarea {
      width: 100%;
      color: var(--text);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
    }
    input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(96,165,250,0.2); }
    textarea { resize: vertical; min-height: 80px; }

    .row { display: flex; gap: 10px; align-items: center; }
    .row > * { flex: 1; }

    .btn {
      appearance: none;
      border: none;
      background: var(--accent);
      color: #04110a;
      font-weight: 700;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 6px 20px rgba(34,197,94,0.25);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.secondary { background: #1f2937; color: var(--text); box-shadow: none; border: 1px solid var(--border); }
    .btn.danger { background: var(--danger); color: white; box-shadow: 0 6px 20px rgba(239,68,68,0.25); }

    .toolbar { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .pill { background: #0b1220; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted); }

    .list {
      display: grid;
      gap: 10px;
    }
    .item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .item-title { font-weight: 700; }
    .item-meta { font-size: 12px; color: var(--muted); }
    .item-actions { display: flex; gap: 8px; }

    .hidden { display: none !important; }

    .footer { margin-top: 18px; text-align: center; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="authCard">
      <h1>Health Manager</h1>
      <div class="muted">Simple demo: sign in as patient, doctor, or admin</div>
      <div style="height: 12px"></div>
      <form id="signInForm">
        <div class="grid">
          <div>
            <label for="name">Your name</label>
            <input id="name" type="text" required placeholder="e.g., Jane Doe" autocomplete="name" />
          </div>
          <div>
            <label for="role">Role</label>
            <select id="role" required>
              <option value="patient">Patient</option>
              <option value="doctor">Doctor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div style="height: 12px"></div>
        <div class="row">
          <button class="btn" type="submit">Sign in</button>
        </div>
      </form>
      <div class="footer">No account yet? <a href="./signup.html">Create one</a></div>
    </div>

    <div class="card hidden" id="appCard">
      <div class="toolbar">
        <div>
          <div class="pill" id="currentUserPill">Signed in</div>
        </div>
        <div class="row" style="justify-content: flex-end; gap: 8px; flex: none;">
          <button class="btn secondary" id="switchRoleBtn" title="Switch role">Switch</button>
          <button class="btn danger" id="signOutBtn">Sign out</button>
        </div>
      </div>

      <div class="grid grid-2">
        <section>
          <h1>Upload Document</h1>
          <div class="muted">Files are kept in-memory for this session only. Metadata is saved.</div>
          <div style="height: 10px"></div>
          <form id="uploadForm">
            <div class="grid">
              <div>
                <label for="fileInput">Choose file</label>
                <input id="fileInput" type="file" />
              </div>
              <div>
                <label for="docNotes">Notes</label>
                <textarea id="docNotes" placeholder="Optional notes about this document"></textarea>
              </div>
            </div>
            <div style="height: 12px"></div>
            <div class="row">
              <button class="btn" type="submit">Upload</button>
            </div>
          </form>
        </section>

        <section>
          <h1>My Info</h1>
          <div class="muted">Update a short note on your profile</div>
          <div style="height: 10px"></div>
          <form id="profileForm">
            <div>
              <label for="profileNote">Profile note</label>
              <textarea id="profileNote" placeholder="e.g., Allergic to penicillin"></textarea>
            </div>
            <div style="height: 12px"></div>
            <div class="row">
              <button class="btn secondary" type="submit">Save note</button>
            </div>
          </form>
        </section>
      </div>

      <div style="height: 16px"></div>

      <section id="patientHealthSection" class="hidden">
        <h1>Health Info (Patient)</h1>
        <div class="muted">Stored locally. Units: height in cm, weight in kg.</div>
        <div style="height: 10px"></div>
        <form id="healthForm">
          <div class="grid grid-2">
            <div>
              <label for="heightCm">Height (cm)</label>
              <input id="heightCm" type="text" inputmode="decimal" placeholder="e.g., 170" />
            </div>
            <div>
              <label for="weightKg">Weight (kg)</label>
              <input id="weightKg" type="text" inputmode="decimal" placeholder="e.g., 65" />
            </div>
            <div>
              <label for="bloodType">Blood type</label>
              <select id="bloodType">
                <option value="">Select</option>
                <option>O+</option>
                <option>O-</option>
                <option>A+</option>
                <option>A-</option>
                <option>B+</option>
                <option>B-</option>
                <option>AB+</option>
                <option>AB-</option>
              </select>
            </div>
            <div>
              <label for="age">Age</label>
              <input id="age" type="text" inputmode="numeric" placeholder="e.g., 34" />
            </div>
          </div>
          <div style="height: 10px"></div>
          <div>
            <label for="allergies">Allergies</label>
            <textarea id="allergies" placeholder="e.g., Peanuts, penicillin"></textarea>
          </div>
          <div style="height: 10px"></div>
          <div>
            <label for="conditions">Conditions</label>
            <textarea id="conditions" placeholder="e.g., Asthma"></textarea>
          </div>
          <div style="height: 12px"></div>
          <div class="row" style="align-items: center;">
            <button class="btn secondary" type="submit">Save health info</button>
            <div class="pill" id="bmiPill">BMI: —</div>
          </div>
        </form>
      </section>

      <section>
        <h1 id="listTitle">Documents</h1>
        <div class="list" id="docList"></div>
      </section>

      <div class="footer">Demo only. No backend. For real apps, use a secure server and storage.</div>
    </div>
  </div>

  <script>
    const storageKeys = Object.freeze({
      currentUser: 'hm.currentUser',
      users: 'hm.users',
      documents: 'hm.documents'
    });

    const inMemoryFiles = new Map();

    function getUsers() {
      const raw = localStorage.getItem(storageKeys.users);
      return raw ? JSON.parse(raw) : [];
    }
    function setUsers(users) {
      localStorage.setItem(storageKeys.users, JSON.stringify(users));
    }
    function getDocuments() {
      const raw = localStorage.getItem(storageKeys.documents);
      return raw ? JSON.parse(raw) : [];
    }
    function setDocuments(docs) {
      localStorage.setItem(storageKeys.documents, JSON.stringify(docs));
    }
    function getCurrentUser() {
      const raw = localStorage.getItem(storageKeys.currentUser);
      return raw ? JSON.parse(raw) : null;
    }
    function setCurrentUser(user) {
      localStorage.setItem(storageKeys.currentUser, JSON.stringify(user));
    }

    function ensureUserExists(name, role) {
      const users = getUsers();
      let user = users.find(u => u.name.toLowerCase() === name.toLowerCase());
      if (!user) {
        user = { id: crypto.randomUUID(), name, role, profileNote: '' };
        users.push(user);
        setUsers(users);
      } else {
        user.role = role; // allow switching role for demo simplicity
        setUsers(users);
      }
      return user;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateUIForUser(user) {
      const authCard = document.getElementById('authCard');
      const appCard = document.getElementById('appCard');
      const pill = document.getElementById('currentUserPill');
      const listTitle = document.getElementById('listTitle');
      const profileNote = document.getElementById('profileNote');
      const healthSection = document.getElementById('patientHealthSection');

      if (!user) {
        authCard.classList.remove('hidden');
        appCard.classList.add('hidden');
        return;
      }

      authCard.classList.add('hidden');
      appCard.classList.remove('hidden');
      pill.textContent = user.name + ' · ' + user.role;

      if (user.role === 'patient') listTitle.textContent = 'My Documents';
      if (user.role === 'doctor') listTitle.textContent = 'All Patient Documents';
      if (user.role === 'admin') listTitle.textContent = 'All Documents (Admin)';

      const users = getUsers();
      const freshUser = users.find(u => u.id === user.id) || user;
      profileNote.value = freshUser.profileNote || '';

      if (healthSection) {
        if (user.role === 'patient') {
          healthSection.classList.remove('hidden');
          prefillHealthForm(freshUser);
        } else {
          healthSection.classList.add('hidden');
        }
      }

      renderDocuments();
    }

    function renderDocuments() {
      const list = document.getElementById('docList');
      list.innerHTML = '';
      const user = getCurrentUser();
      if (!user) return;

      const docs = getDocuments();
      let filtered = docs;
      if (user.role === 'patient') filtered = docs.filter(d => d.ownerId === user.id);
      if (user.role === 'doctor') {
        const users = getUsers();
        const patientIds = users.filter(u => u.role === 'patient').map(u => u.id);
        filtered = docs.filter(d => patientIds.includes(d.ownerId));
      }

      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'No documents yet.';
        list.appendChild(empty);
        return;
      }

      filtered
        .sort((a, b) => b.createdAt - a.createdAt)
        .forEach(doc => {
          const owner = getUsers().find(u => u.id === doc.ownerId);
          const item = document.createElement('div');
          item.className = 'item';

          const left = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'item-title';
          title.textContent = doc.fileName;

          const meta = document.createElement('div');
          meta.className = 'item-meta';
          const date = new Date(doc.createdAt).toLocaleString();
          const ownerStr = owner ? owner.name + ' (' + owner.role + ')' : 'Unknown';
          meta.textContent = ownerStr + ' · ' + formatBytes(doc.fileSize) + ' · ' + date + (doc.notes ? ' · ' + doc.notes : '');

          left.appendChild(title);
          left.appendChild(meta);

          const actions = document.createElement('div');
          actions.className = 'item-actions';

          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn secondary';
          viewBtn.textContent = 'View';
          viewBtn.onclick = () => {
            const blob = inMemoryFiles.get(doc.id);
            if (!blob) { alert('File not available (only kept in-memory this session).'); return; }
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(() => URL.revokeObjectURL(url), 10000);
          };

          const delBtn = document.createElement('button');
          delBtn.className = 'btn danger';
          delBtn.textContent = 'Delete';
          delBtn.onclick = () => {
            const confirmDel = confirm('Delete "' + doc.fileName + '"?');
            if (!confirmDel) return;
            const remaining = getDocuments().filter(d => d.id !== doc.id);
            setDocuments(remaining);
            inMemoryFiles.delete(doc.id);
            renderDocuments();
          };

          actions.appendChild(viewBtn);

          const canDelete = user.role === 'admin' || doc.ownerId === user.id;
          if (canDelete) actions.appendChild(delBtn);

          item.appendChild(left);
          item.appendChild(actions);
          list.appendChild(item);
        });
    }

    document.getElementById('signInForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const role = document.getElementById('role').value;
      if (!name) { alert('Please enter your name'); return; }
      const user = ensureUserExists(name, role);
      setCurrentUser(user);
      updateUIForUser(user);
    });

    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem(storageKeys.currentUser);
      updateUIForUser(null);
    });

    document.getElementById('switchRoleBtn').addEventListener('click', () => {
      const user = getCurrentUser();
      if (!user) return;
      const next = user.role === 'patient' ? 'doctor' : user.role === 'doctor' ? 'admin' : 'patient';
      const users = getUsers();
      const idx = users.findIndex(u => u.id === user.id);
      if (idx >= 0) {
        users[idx].role = next;
        setUsers(users);
        setCurrentUser(users[idx]);
        updateUIForUser(users[idx]);
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) { alert('Please sign in first.'); return; }
      const input = document.getElementById('fileInput');
      const notes = document.getElementById('docNotes').value.trim();
      if (!input.files || input.files.length === 0) { alert('Select a file to upload.'); return; }
      const file = input.files[0];

      const arrayBuffer = await file.arrayBuffer();
      const blob = new Blob([arrayBuffer], { type: file.type || 'application/octet-stream' });

      const doc = {
        id: crypto.randomUUID(),
        ownerId: user.id,
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type,
        createdAt: Date.now(),
        notes
      };

      const docs = getDocuments();
      docs.push(doc);
      setDocuments(docs);
      inMemoryFiles.set(doc.id, blob);

      document.getElementById('fileInput').value = '';
      document.getElementById('docNotes').value = '';
      renderDocuments();
    });

    document.getElementById('profileForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) return;
      const note = document.getElementById('profileNote').value.trim();
      const users = getUsers();
      const idx = users.findIndex(u => u.id === user.id);
      if (idx >= 0) {
        users[idx].profileNote = note;
        setUsers(users);
        setCurrentUser(users[idx]);
      }
      alert('Saved');
    });

    function parseNumber(value) {
      if (typeof value !== 'string') return null;
      const v = value.replace(/,/g, '.').trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function computeAndShowBmi() {
      const h = parseNumber(document.getElementById('heightCm').value);
      const w = parseNumber(document.getElementById('weightKg').value);
      const pill = document.getElementById('bmiPill');
      if (!pill) return;
      if (!h || !w || h <= 0 || w <= 0) { pill.textContent = 'BMI: —'; return; }
      const meters = h / 100;
      const bmi = w / (meters * meters);
      pill.textContent = 'BMI: ' + bmi.toFixed(1);
    }

    function prefillHealthForm(user) {
      const health = (user && user.health) || {};
      document.getElementById('heightCm').value = health.heightCm ?? '';
      document.getElementById('weightKg').value = health.weightKg ?? '';
      document.getElementById('bloodType').value = health.bloodType ?? '';
      document.getElementById('age').value = health.age ?? '';
      document.getElementById('allergies').value = health.allergies ?? '';
      document.getElementById('conditions').value = health.conditions ?? '';
      computeAndShowBmi();
    }

    ['heightCm','weightKg'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', computeAndShowBmi);
    });

    document.getElementById('healthForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) return;
      const heightCm = parseNumber(document.getElementById('heightCm').value);
      const weightKg = parseNumber(document.getElementById('weightKg').value);
      const bloodType = document.getElementById('bloodType').value;
      const age = parseNumber(document.getElementById('age').value);
      const allergies = document.getElementById('allergies').value.trim();
      const conditions = document.getElementById('conditions').value.trim();

      const users = getUsers();
      const idx = users.findIndex(u => u.id === user.id);
      if (idx >= 0) {
        users[idx].health = {
          heightCm: heightCm ?? null,
          weightKg: weightKg ?? null,
          bloodType: bloodType || '',
          age: age ?? null,
          allergies,
          conditions
        };
        setUsers(users);
        setCurrentUser(users[idx]);
      }
      computeAndShowBmi();
      alert('Health info saved');
    });

    window.addEventListener('storage', () => {
      // Keep multiple tabs in sync
      updateUIForUser(getCurrentUser());
    });

    // Init
    updateUIForUser(getCurrentUser());
  </script>
</body>
</html>